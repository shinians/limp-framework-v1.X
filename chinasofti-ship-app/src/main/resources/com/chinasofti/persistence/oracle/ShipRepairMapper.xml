<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.chinasofti.mapper.oracle.ShipRepairMapper" >
  <resultMap id="BaseResultMap" type="com.chinasofti.domain.ShipRepair" >
    <result column="CSR_ID" property="id" jdbcType="VARCHAR" />
    <result column="CSR_SHIPNAME" property="shipname" jdbcType="VARCHAR" />
    <result column="CSR_REPTIME" property="reptime" jdbcType="VARCHAR" />
    <result column="CSR_REPITEMS" property="repitems" jdbcType="VARCHAR" />
    <result column="CSR_REPREASON" property="repreason" jdbcType="VARCHAR" />
    <result column="CSR_REPCONTENT" property="repcontent" jdbcType="VARCHAR" />
    <result column="CSR_REPPERSON" property="repperson" jdbcType="VARCHAR" />
    <result column="CSR_REPUNIT" property="repunit" jdbcType="VARCHAR" />
    <result column="CSR_ENTNAME" property="entname" jdbcType="VARCHAR" />
    <result column="CSR_ENTID" property="entid" jdbcType="VARCHAR" />
    <association column="CSR_SHIPID" property="ship" select="selectShip"  javaType="com.chinasofti.domain.Ship"/>
    <!--<result column="CSR_SHIPID" property="shipid" jdbcType="VARCHAR" />-->
  </resultMap>

  <resultMap id="ShipResultMap" type="com.chinasofti.domain.Ship">
    <result column="CS_SHIPPORT" property="shipport" jdbcType="VARCHAR" />
    <result column="CS_SHIPNAME" property="shipname" jdbcType="VARCHAR" />
    <result column="CS_SHIPLENGTH" property="shiplength" jdbcType="VARCHAR" />
    <result column="CS_POWER" property="power" jdbcType="VARCHAR" />
    <result column="CS_TONNAGE" property="tonnage" jdbcType="VARCHAR" />
    <result column="CS_COMPLETDATE" property="completdate" jdbcType="VARCHAR" />
    <result column="CS_DRAWNO" property="drawno" jdbcType="VARCHAR" />
    <result column="CS_ENTNAMEDES" property="entnamedes" jdbcType="VARCHAR" />
  </resultMap>

  <sql id="Example_Where_Clause" >
    <where >
      <foreach collection="oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause" >
    <where >
      <foreach collection="example.oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List" >
    CSR_ID, CSR_SHIPNAME, CSR_SHIPID, CSR_REPTIME, CSR_REPITEMS, CSR_REPREASON, CSR_REPCONTENT, 
    CSR_REPPERSON, CSR_REPUNIT, CSR_ENTID, CSR_ENTNAME
  </sql>

  <select id="selectByExample" resultMap="BaseResultMap" parameterType="com.chinasofti.domain.ShipRepairExample" >
    <include refid="OracleDialectPrefix" />
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List" />
    from CIS_SHIP_REPAIR
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
    <include refid="OracleDialectSuffix" />
  </select>

  <delete id="deleteByExample" parameterType="com.chinasofti.domain.ShipRepairExample" >
    delete from CIS_SHIP_REPAIR
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="com.chinasofti.domain.ShipRepair" >
    insert into CIS_SHIP_REPAIR (CSR_ID, CSR_SHIPNAME, CSR_SHIPID, 
      CSR_REPTIME, CSR_REPITEMS, CSR_REPREASON, 
      CSR_REPCONTENT, CSR_REPPERSON, CSR_REPUNIT, 
      CSR_ENTID, CSR_ENTNAME)
    values (#{id,jdbcType=VARCHAR}, #{shipname,jdbcType=VARCHAR}, #{shipid,jdbcType=VARCHAR}, 
      #{reptime,jdbcType=VARCHAR}, #{repitems,jdbcType=VARCHAR}, #{repreason,jdbcType=VARCHAR}, 
      #{repcontent,jdbcType=VARCHAR}, #{repperson,jdbcType=VARCHAR}, #{repunit,jdbcType=VARCHAR}, 
      #{entid,jdbcType=VARCHAR}, #{entname,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.chinasofti.domain.ShipRepair" >
    insert into CIS_SHIP_REPAIR
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        CSR_ID,
      </if>
      <if test="shipname != null" >
        CSR_SHIPNAME,
      </if>
      <if test="shipid != null" >
        CSR_SHIPID,
      </if>
      <if test="reptime != null" >
        CSR_REPTIME,
      </if>
      <if test="repitems != null" >
        CSR_REPITEMS,
      </if>
      <if test="repreason != null" >
        CSR_REPREASON,
      </if>
      <if test="repcontent != null" >
        CSR_REPCONTENT,
      </if>
      <if test="repperson != null" >
        CSR_REPPERSON,
      </if>
      <if test="repunit != null" >
        CSR_REPUNIT,
      </if>
      <if test="entid != null" >
        CSR_ENTID,
      </if>
      <if test="entname != null" >
        CSR_ENTNAME,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="shipname != null" >
        #{shipname,jdbcType=VARCHAR},
      </if>
      <if test="shipid != null" >
        #{shipid,jdbcType=VARCHAR},
      </if>
      <if test="reptime != null" >
        #{reptime,jdbcType=VARCHAR},
      </if>
      <if test="repitems != null" >
        #{repitems,jdbcType=VARCHAR},
      </if>
      <if test="repreason != null" >
        #{repreason,jdbcType=VARCHAR},
      </if>
      <if test="repcontent != null" >
        #{repcontent,jdbcType=VARCHAR},
      </if>
      <if test="repperson != null" >
        #{repperson,jdbcType=VARCHAR},
      </if>
      <if test="repunit != null" >
        #{repunit,jdbcType=VARCHAR},
      </if>
      <if test="entid != null" >
        #{entid,jdbcType=VARCHAR},
      </if>
      <if test="entname != null" >
        #{entname,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <select id="countByExample" parameterType="com.chinasofti.domain.ShipRepairExample" resultType="java.lang.Integer" >
    select count(*) from CIS_SHIP_REPAIR
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map" >
    update CIS_SHIP_REPAIR
    <set >
      <if test="record.id != null" >
        CSR_ID = #{record.id,jdbcType=VARCHAR},
      </if>
      <if test="record.shipname != null" >
        CSR_SHIPNAME = #{record.shipname,jdbcType=VARCHAR},
      </if>
      <if test="record.shipid != null" >
        CSR_SHIPID = #{record.shipid,jdbcType=VARCHAR},
      </if>
      <if test="record.reptime != null" >
        CSR_REPTIME = #{record.reptime,jdbcType=VARCHAR},
      </if>
      <if test="record.repitems != null" >
        CSR_REPITEMS = #{record.repitems,jdbcType=VARCHAR},
      </if>
      <if test="record.repreason != null" >
        CSR_REPREASON = #{record.repreason,jdbcType=VARCHAR},
      </if>
      <if test="record.repcontent != null" >
        CSR_REPCONTENT = #{record.repcontent,jdbcType=VARCHAR},
      </if>
      <if test="record.repperson != null" >
        CSR_REPPERSON = #{record.repperson,jdbcType=VARCHAR},
      </if>
      <if test="record.repunit != null" >
        CSR_REPUNIT = #{record.repunit,jdbcType=VARCHAR},
      </if>
      <if test="record.entid != null" >
        CSR_ENTID = #{record.entid,jdbcType=VARCHAR},
      </if>
      <if test="record.entname != null" >
        CSR_ENTNAME = #{record.entname,jdbcType=VARCHAR},
      </if>
    </set>
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map" >
    update CIS_SHIP_REPAIR
    set CSR_ID = #{record.id,jdbcType=VARCHAR},
      CSR_SHIPNAME = #{record.shipname,jdbcType=VARCHAR},
      CSR_SHIPID = #{record.shipid,jdbcType=VARCHAR},
      CSR_REPTIME = #{record.reptime,jdbcType=VARCHAR},
      CSR_REPITEMS = #{record.repitems,jdbcType=VARCHAR},
      CSR_REPREASON = #{record.repreason,jdbcType=VARCHAR},
      CSR_REPCONTENT = #{record.repcontent,jdbcType=VARCHAR},
      CSR_REPPERSON = #{record.repperson,jdbcType=VARCHAR},
      CSR_REPUNIT = #{record.repunit,jdbcType=VARCHAR},
      CSR_ENTID = #{record.entid,jdbcType=VARCHAR},
      CSR_ENTNAME = #{record.entname,jdbcType=VARCHAR}
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <sql id="OracleDialectPrefix" >
    <if test="page != null" >
      select * from ( select row_.*, rownum rownum_ from ( 
    </if>
  </sql>
  <sql id="OracleDialectSuffix" >
    <if test="page != null" >
      <![CDATA[ ) row_  where rownum<= #{page.end}) where rownum_ > #{page.start} ]]>
    </if>
  </sql>

  <select id="getShipIdsByEnt" parameterType="String" resultType="String">
    select CSR_SHIPID from CIS_SHIP_REPAIR where CSR_ENTID = #{pid}
  </select>

  <select id="selectShip" parameterType="String" resultMap="ShipResultMap">
    select CS_SHIPPORT,CS_SHIPNAME,CS_SHIPLENGTH,CS_POWER,CS_TONNAGE,CS_COMPLETDATE,CS_DRAWNO,CS_ENTNAMEDES from CIS_SHIPINFO where CS_ID = #{CSR_SHIPID}
  </select>

  <sql id="caseWhen1">
      CASE WHEN to_number(csi.CS_SHIPLENGTH) &lt; 12 THEN 'L&lt;12米'
      WHEN 12&lt;=to_number(csi.CS_SHIPLENGTH) AND to_number(csi.CS_SHIPLENGTH) &lt; 24 THEN '12米&lt;L&lt;24米'
      WHEN 24&lt;=to_number(csi.CS_SHIPLENGTH) AND to_number(csi.CS_SHIPLENGTH) &lt; 45 THEN '24米&lt;L&lt;45米'
      WHEN 45&lt;=to_number(csi.CS_SHIPLENGTH) THEN 'L&gt;45米'
      ELSE NULL END "length"
  </sql>
  <sql id="caseWhen2">
    CASE WHEN to_number(csi.CS_SHIPLENGTH) &lt; 12 THEN 'L&lt;12米'
      WHEN 12&lt;=to_number(csi.CS_SHIPLENGTH) AND to_number(csi.CS_SHIPLENGTH) &lt; 24 THEN '12米&lt;L&lt;24米'
      WHEN 24&lt;=to_number(csi.CS_SHIPLENGTH) AND to_number(csi.CS_SHIPLENGTH) &lt; 45 THEN '24米&lt;L&lt;45米'
      WHEN 45&lt;=to_number(csi.CS_SHIPLENGTH) THEN 'L&gt;45米'
      ELSE NULL END
  </sql>

  <select id="countTimesGroupYear" parameterType="String" resultType="java.util.HashMap">
      SELECT substr(csr.csr_reptime,0,4) "year",
      <include refid="caseWhen1"/>
      ,count(*) "times"
      FROM CIS_SHIP_REPAIR csr INNER JOIN  cis_shipinfo csi ON  csr.csr_shipid =csi.cs_shipcode
      WHERE csr.CSR_ENTID = #{pid}
      <!--AND to_number(#{beginYear}) &lt; to_number(csr.csr_reptime) AND to_number(csr.csr_reptime) &lt;= to_number(#{endYear})-->
      GROUP BY substr(csr.csr_reptime,0,4),
      <include refid="caseWhen2"/>
      ORDER BY substr(csr.csr_reptime,0,4)
  </select>

  <select id="countRatesGroupYear" parameterType="String" resultType="java.util.HashMap">
    SELECT  t2.year "year",nvl(round((t1.times/t2.times)*100,2),0) "rate" FROM

    (select substr(year,0,4) year,count(*) times from  THEM_SHIP_REPAIR_CHECK tsrc INNER JOIN CIS_SHIPINFO csi ON tsrc.SHIPNUM = csi.CS_SHIPCODE
    WHERE tsrc.ENTID=#{pid} AND tsrc.CHECKNUM =1 and #{beginLength} &lt;= to_number(csi.cs_shiplength) AND  to_number(csi.cs_shiplength) &lt;#{endLength}
    GROUP BY substr(year,0,4)) t1 right join
    (select substr(year,0,4) year,count(*) times from  THEM_SHIP_REPAIR_CHECK tsrc INNER JOIN CIS_SHIPINFO csi ON tsrc.SHIPNUM = csi.CS_SHIPCODE
    WHERE tsrc.ENTID=#{pid} and #{beginLength} &lt;= to_number(csi.cs_shiplength) AND  to_number(csi.cs_shiplength) &lt;#{endLength}
    GROUP BY substr(year,0,4)) t2 on t1.year=t2.year
    <!--where to_number(#{beginYear}) &lt; to_number(t2.year) AND to_number(t2.year) &lt;= to_number(#{endYear})-->
    order by t2.year
  </select>

  <select id="selectByEntId" parameterType="String" resultType="HashMap">
    SELECT * FROM
    (SELECT a.*,rownum rn FROM
    (SELECT csr.CSR_ID,csr.CSR_SHIPNAME,csi.CS_SHIPLENGTH,csi.CS_POWER,csr.CSR_REPTIME
    FROM  CIS_SHIP_REPAIR csr INNER JOIN  cis_shipinfo csi ON  csr.csr_shipid =csi.cs_shipcode
    WHERE csr.csr_entid = #{pid}
    <if test="shipName!=null">
      AND csr.CSR_SHIPNAME LIKE  #{shipName}
    </if>
    ORDER BY csr.CSR_REPTIME) a)
    WHERE rn BETWEEN #{beginRow} and #{endRow}
  </select>
  <select id="countByEntId" parameterType="String" resultType="int">
    SELECT count(*)
    FROM  CIS_SHIP_REPAIR csr INNER JOIN  cis_shipinfo csi ON  csr.csr_shipid =csi.cs_shipcode
    WHERE csr.csr_entid = #{pid}
    <if test="shipName!=null">
      AND csr.CSR_SHIPNAME LIKE  #{shipName}
    </if>
  </select>
</mapper>